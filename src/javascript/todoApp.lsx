
{ filter, map, zip } = require "prelude-ls"

TodoItem = React.create-class do

    on-change: (e) ->
        e.target.checked
        |> @props.on-finished-change

    render: ->
        ``<span>
            <input type="checkbox" checked={this.props.finished} id={this.props.text} onChange={this.onChange} />
            <label htmlFor={this.props.text}>{this.props.text}</label>
            <button className="del" onClick={this.props.onDelete}>X</button>
          </span>``

TodoList = React.create-class do

    get-initial-state: ->
        name: "default"
        items: []
        new-task-text: ""

    component-did-mount: !->
        @load-list @props.list-index

    component-will-receive-props: (new-props) !->
        @load-list new-props.list-index

    load-list: (list-index) !->
        list = todo-storage.load-list list-index
        @set-state do
            if list
                name: list.name ? "default"
                items: list.items ? []
            else
                name: "default"
                items: []

    save-list: (new-items) !->
        todo-storage.save-list @props.list-index, { name: @state.name, items: new-items }

    on-new-task-text-change: (e) !->
        @set-state new-task-text: e.target.value

    on-new-task: (e) ->
        e.prevent-default!
        new-items = @state.items ++ [ text: @state.new-task-text, finished: false ]
        @set-state do
            items: new-items
            new-task-text: ""
        @save-list new-items
        false

    create-item: (item) ->

        on-delete = (e) ~>
            e.prevent-default!
            new-items = @state.items
                        |> filter (x) -> x != item
            @set-state items: new-items
            @save-list new-items
            false

        on-finished-change = (x) ~>
            item.finished = x
            new-items = @state.items
            @set-state items: new-items
            @save-list new-items
            false

        ``<li>
            <TodoItem text={item.text} finished={item.finished} onDelete={onDelete} onFinishedChange={onFinishedChange}/>
          </li>``

    on-delete-list: (e) ->
        @props.on-delete-list e, @props.list-index

    render: ->
        visible-name =
            | !@state.name or @state.name == "" => "(no-name)"
            | _ => @state.name

        children = @state.items
                   |> map (@createItem)

        ``<div id="todo_list">
            <form onSubmit={this.onDeleteList}>
                <button className="del">Delete list</button>
            </form>
            <h4>{visibleName}</h4>
            <ul>
                {children}
                <form onSubmit={this.onNewTask}>
                    <input type="text" placeholder="new task" onChange={this.onNewTaskTextChange} value={this.state.newTaskText} />
                    <button>Add item</button>
                </form>
            </ul>
          </div>``

TodoApp = React.create-class do
    
    get-initial-state: ->
        lists-names: []
        selected-index: 0
        new-list-name: ""

    component-did-mount: !->
        @set-state lists-names: @load-lists!

    load-lists: ->
        todo-storage.load-list-names!

    create-list-selector: ([index, name]) ->

        select-list = (e) ~>
            e.prevent-default!
            @set-state selected-index: index
            false

        selectable-name =
            | !name or name == "" => "(no-name)"
            | _ => name

        ``<li>
            <a href="#" onClick={selectList}>{selectableName}</a>
          </li>``

    on-new-list-name-change: (e) !->
        @set-state new-list-name: e.target.value

    on-new-list: (e) ->
        e.prevent-default!
        new-list-index = todo-storage.save-new-list @state.new-list-name
        @set-state do
            lists-names: @load-lists!
            new-list-name: ""
            selected-index: new-list-index
        false

    on-delete-list: (e, list-index) ->
        e.prevent-default!
        todo-storage.delete-list list-index
        @set-state do
            lists-names: @load-lists!
            selected-index: 0
        false

    render: ->
        list-selectors = @state.lists-names
                         |> zip [0 til @state.lists-names.length]
                         |> map (@create-list-selector)
        ``<div>
            <div id="todo_lists">
                <ul>
                    {listSelectors}
                    <li>
                        <form onSubmit={this.onNewList}>
                            <input type="text" placeholder="new list" onChange={this.onNewListNameChange} value={this.state.newListName} />
                            <button>Add list</button>
                        </form>
                    </li>
                </ul>
            </div>
            <TodoList listIndex={this.state.selectedIndex} onDeleteList={this.onDeleteList} />
            <div className="clear"></div>
          </div>``

React.render do
    ``<TodoApp />``
    document.get-element-by-id "todo_app"
